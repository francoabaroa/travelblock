<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Travelblock front-end</title>
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script language="javascript" type="text/javascript" src="../packages/lib/INSERT_ABI_JS_LIBRARY_HERE.js"></script>
  </head>
  <body>
    <div id="txStatus"></div>
    <div id="cities"></div>

    <script>
      var travelblock;
      var userAccount;

      function startApp() {
        var travelblockAddress = "Travelblock_CONTRACT_ADDRESS";
        // travelblockABI defined where??
        travelblock = new web3js.eth.Contract(travelblockABI, travelblockAddress);

        var accountInterval = setInterval(function() {
          if (web3.eth.accounts[0] !== userAccount) {
            userAccount = web3.eth.accounts[0];
            getCitiesByOwner(userAccount)
            .then(displayCities);
          }
        }, 100);

        travelblock.events.Transfer({ filter: { _to: userAccount } })
        .on("data", function(event) {
          let data = event.returnValues;
          getCitiesByOwner(userAccount).then(displayCities);
        }).on("error", console.error);
      }

      function displayCities(ids) {
        $("#cities").empty();
        for (id of ids) {
          getCityDetails(id)
          .then(function(city) {
            $("#cities").append(`<div class="city">
              <ul>
                <li>Name: ${city.name}</li>
                <li>Name: ${city.lat}</li>
                <li>Name: ${city.lng}</li>
                <li>Name: ${city.state}</li>
                <li>Name: ${city.country}</li>
              </ul>
            </div>`);
          });
        }
      }

      function saveCityVisited(name, lat, lng, state, country) {
        $("#txStatus").text("Engraving the city you visited into your travelblock journal. This may take a while...");
        return travelblock.methods.saveCityVisited(name, lat, lng, state, country)
        .send({ from: userAccount })
        .on("receipt", function(receipt) {
          $("#txStatus").text("Successfully engraved " + name + " into your travelblock!");
          getCitiesByOwner(userAccount).then(displayCities);
        })
        .on("error", function(error) {
          // TODO: display meaningful errror message
          $("#txStatus").text(error);
        });
      }

      function getCityDetails(id) {
        return travelblock.methods.cities(id).call();
      }

      // Needed?
      function cityToOwner(id) {
        return travelblock.methods.cityToOwner(id).call();
      }

      function getCitiesByOwner(owner) {
        return travelblock.methods.getCitiesByOwner(owner).call();
      }

      window.addEventListener('load', function() {
        if (typeof web3 !== 'undefined') {
          web3js = new Web3(web3.currentProvider);
        } else {
          // TODO: Handle the case where the user doesn't have Metamask installed
        }
        startApp()
      })
    </script>
  </body>
</html>
